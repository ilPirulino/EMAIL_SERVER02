<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scarica il PDF</title>
    <link rel="stylesheet" href="frontend/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</head>
<body>
    <div class="page-container">
        <h1 class="common-title">SERVER PER REPORT DI INTERVENTI TECNICI</h1>
        <div class="main-content">
            <div class="container" style="margin-right: 10px;">
                <h2>Send Email</h2>
                <div class="form-container">
                    <div class="form-group">
                        <label for="Sender">Sender Name</label>
                        <input type="text" id="Sender" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="To">To (Email)</label>
                        <select id="To" class="form-control">
                            <option value="">Choose an address</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="Subject">Subject</label>
                        <input type="text" id="Subject" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="replyto">Reply To (Email)</label>
                        <input type="text" id="replyto" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="message">Message</label>
                        <textarea id="message" class="form-control" cols="40" rows="8"></textarea>
                    </div>
                    <button onclick="sendMail();" class="btn">Send</button>
                </div>
            </div>
            <div class="container" style="margin-left: 10px;">
                <h2>Reports and People</h2>
                <div class="form-container" id="fileload">
                    <p>Select Files:</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        function sendMail() {
            (function () {
                emailjs.init("my7cTzIrXbJyZf_0z");
            })();

            var link = "<br><a href=\"https://ilpirulino.github.io/EMAIL_SERVER02/\">Link Sito</a>";

            var params = {
                Sender: document.querySelector("#Sender").value,
                To: document.querySelector("#To").value,
                Subject: document.querySelector("#Subject").value,
                replyto: document.querySelector("#replyto").value,
                message: document.querySelector("#message").value + link,
            };

            // Aggiungi gli allegati dalle checkbox
            var checkboxes = document.querySelectorAll("#fileload input[type='checkbox']:checked");
            var attachments = [];

            checkboxes.forEach((checkbox, index) => {
                attachments.push(checkbox.value);
            });

            // Aggiungi gli URL degli allegati ai parametri
            attachments.forEach((attachment, index) => {
                params['attachment' + index] = attachment;
            });

            var serviceID = "service_plf6iaf";
            var templateID = "template_3hhhd3d";

            emailjs.send(serviceID, templateID, params)
                .then(res => {
                    alert("Email sent successfully!");
                })
                .catch(err => {
                    console.error("Error sending email:", err);
                    alert("Failed to send email. Please try again later.");
                });
        }

        async function loadAddresses() {
            try {
                const response = await fetch('frontend/Files/address_options.txt');
                const data = await response.text();
                const options = data.split('\n').map(option => option.trim()).filter(option => option);
                const dropdownMenu = document.getElementById("To");
                dropdownMenu.innerHTML = '<option value="">Choose an address</option>';
                options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    dropdownMenu.appendChild(optionElement);
                });
            } catch (error) {
                console.error('Options Load Error');
            }
        }

        async function loadAttachments() {
            try {
                const response = await fetch('frontend/Files/report_files.txt');
                const data = await response.text();
                const files = data.split('\n').map(file => file.trim()).filter(file => file);
                const fileContainer = document.getElementById('fileload');
                files.forEach(file => {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = file;
                    checkbox.id = file;
                    const label = document.createElement('label');
                    label.htmlFor = file;
                    label.textContent = file;
                    const div = document.createElement('div');
                    div.appendChild(checkbox);
                    div.appendChild(label);
                    fileContainer.appendChild(div);
                });
            } catch (error) {
                console.error('Report Files Load Error', error);
            }
        }

        function initialize() {
            loadAddresses();
            loadAttachments();
        }

        window.onload = initialize;
    </script>
</body>
</html>
